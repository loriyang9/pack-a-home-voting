<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>「打包一個家」防災臨時生活創新設計</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&family=Shippori+Mincho:wght@500;700&display=swap"
        rel="stylesheet">
    <style>
        /* 侘寂風格 - 紙/墨/苔 */
        :root {
            --bg: #F8F6F2;
            /* 暖紙色 */
            --text: #2A2522;
            /* 墨茶色 */
            --text-muted: #6F6660;
            /* 次要文字灰茶 */
            --accent: #5E6B60;
            /* 灰苔綠 */
            --border: rgba(42, 37, 34, .12);
            /* 超淡墨線 */
            --card: #FFFEFA;
            /* 紙白 */
            --radius: 8px;
            /* 便利貼紙色 */
            --paper-1: #FBF3E6;
            --paper-2: #F1F3EF;
            --paper-3: #F4EEE7;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            padding-bottom: 40px;
            line-height: 1.85;
        }

        h1,
        h2 {
            font-family: 'Shippori Mincho', serif;
            text-align: center;
            line-height: 1.3;
            letter-spacing: 0.02em;
        }

        h1 {
            margin-top: 30px;
            color: var(--text);
            font-size: 1.6rem;
        }

        h2 {
            font-size: 1.15rem;
            color: var(--text-muted);
            margin-bottom: 24px;
            font-weight: 500;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 限制內容寬度以保持閱讀性（除了便利貼牆） */
        #page-vote>h1,
        #page-vote>.intro-text,
        #page-vote>.card,
        #page-vote>.btn,
        #page-feedback>* {
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .card {
            background: var(--card);
            padding: 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(42, 37, 34, .04);
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin: 15px 0 8px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            font-size: 1rem;
            box-sizing: border-box;
            color: var(--text);
        }

        textarea {
            min-height: 100px;
            resize: none;
        }

        /* 按鈕 - 霧面紙卡感 */
        .btn {
            display: block;
            width: 100%;
            padding: 14px 20px;
            background: var(--accent);
            color: #FAFAF8;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 15px;
            box-shadow: 0 1px 2px rgba(42, 37, 34, .1);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .btn:hover {
            transform: scale(0.98);
            box-shadow: 0 0 0 rgba(42, 37, 34, .05);
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn:disabled {
            background: rgba(42, 37, 34, .25);
            color: rgba(255, 255, 255, .7);
            cursor: not-allowed;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            box-shadow: none;
        }

        .btn-outline:hover {
            background: rgba(94, 107, 96, .06);
        }

        /* 作品多選 Checkbox */
        .work-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.2s;
            background: var(--card);
        }

        .work-item.selected {
            border-color: var(--accent);
            background: rgba(94, 107, 96, .08);
        }

        .work-item input {
            margin-right: 12px;
            transform: scale(1.2);
        }

        /* 家庭多選 Chips - 印章感 */
        .chip-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .chip {
            padding: 8px 18px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            background: var(--card);
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .chip:hover {
            border-color: var(--accent);
        }

        .chip.active {
            background: rgba(94, 107, 96, .06);
            color: var(--text);
            border: 1.5px solid var(--accent);
            font-weight: 500;
        }

        /* 投票統計長條圖 */
        .stats-section {
            margin: 20px 0;
        }

        .bar-item {
            margin-bottom: 16px;
        }

        .bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .bar-label .name {
            font-weight: 500;
        }

        .bar-label .count {
            color: var(--accent);
            font-weight: 600;
        }

        .bar-track {
            background: rgba(42, 37, 34, .06);
            border-radius: 6px;
            height: 20px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .bar-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 5px;
            transition: width 0.6s ease;
            min-width: 2px;
        }

        /* 便利貼牆 */
        .wall-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        @media (min-width: 768px) {
            .wall-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .sticky {
            background: var(--paper-1);
            padding: 16px;
            border-radius: 3px;
            font-size: 0.9rem;
            box-shadow: 0 1px 3px rgba(42, 37, 34, .06);
            cursor: pointer;
            border-left: 3px solid var(--border);
            /* 動畫效果 */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .sticky.visible {
            opacity: 1;
            transform: translateY(0) rotate(0deg);
        }

        /* 便利貼微旋轉 - 手貼感 */
        .sticky:nth-child(6n+1) {
            background: var(--paper-1);
        }

        .sticky:nth-child(6n+1).visible {
            transform: rotate(-0.3deg);
        }

        .sticky:nth-child(6n+2) {
            background: var(--paper-2);
        }

        .sticky:nth-child(6n+2).visible {
            transform: rotate(0.2deg);
        }

        .sticky:nth-child(6n+3) {
            background: var(--paper-3);
        }

        .sticky:nth-child(6n+3).visible {
            transform: rotate(-0.15deg);
        }

        .sticky:nth-child(6n+4) {
            background: var(--paper-1);
        }

        .sticky:nth-child(6n+4).visible {
            transform: rotate(0.35deg);
        }

        .sticky:nth-child(6n+5) {
            background: var(--paper-2);
        }

        .sticky:nth-child(6n+5).visible {
            transform: rotate(-0.25deg);
        }

        .sticky:nth-child(6n+6) {
            background: var(--paper-3);
        }

        .sticky:nth-child(6n+6).visible {
            transform: rotate(0.4deg);
        }

        /* 段落間距 */
        .card p {
            margin-bottom: 1.2em;
        }

        .card p:last-child {
            margin-bottom: 0;
        }

        /* Modal - 柔光紙盒 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(42, 37, 34, 0.25);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 99;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            padding: 28px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(42, 37, 34, 0.1);
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* intro 文字區塊 */
        .intro-text {
            margin-bottom: 30px;
            line-height: 1.8;
            text-align: justify;
            color: #555;
            font-size: 0.95rem;
        }

        .intro-text p {
            margin-bottom: 15px;
        }

        .intro-text p:last-child {
            margin-bottom: 0;
        }

        /* 分隔線 */
        .divider {
            border: 0;
            border-top: 1px solid #EEE;
            margin: 40px 0;
        }

        .divider--modal {
            border: 0;
            border-top: 1px solid #EEE;
            margin: 15px 0;
        }

        /* modal 內文字 */
        .modal-title {
            margin-top: 0;
        }

        .modal-meta {
            color: #888;
            font-size: 0.9rem;
        }

        .modal-text {
            white-space: pre-wrap;
        }

        /* 置中載入/提示文 */
        .center-hint {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .grid-full {
            grid-column: 1 / -1;
        }

        /* 便利貼內容 */
        .sticky-title {
            color: #6D8494;
            font-size: 0.85rem;
        }

        .sticky-preview {
            margin-top: 5px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 6;
            -webkit-box-orient: vertical;
        }
    </style>
</head>

<body>

    <div class="container">

        <div id="page-vote" class="page active">
            <h1>「打包一個家」防災臨時生活創新設計</h1>
            <div class="intro-text">
                <p>
                    「打包一個家」是富迪印刷自2022啟動的永續計畫，運用集團包裝結構設計與材質創新的實力，投入於具永續價值的社會議題中。今年我們的設計團隊與製造生產線，正在協助災後避難收容過程中，能有更安全、安心、易用的安置工具。
                </p>
                <p>我們相信跨領域的協作始能激發創新，因此在這個階段，期待能邀請你成為產品測試的一員，藉由你的自身經驗協助團隊了解使用者對於目前產品的觀點。</p>
            </div>
            <div class="card">
                <p>請參觀四項作品，試想在緊急災難時刻，你會想用哪一個呢？（可多選）</p>
                <div id="works-list">
                    <label class="work-item" onclick="toggleStyle(this)">
                        <input type="checkbox" name="work" value="Taipei1">
                        <span>助眠罩：避難時的遮光好眠設計</span>
                    </label>
                    <label class="work-item" onclick="toggleStyle(this)">
                        <input type="checkbox" name="work" value="Taipei2">
                        <span>靜心屏：在緊急避難環境劃出一隅私人空間</span>
                    </label>
                    <label class="work-item" onclick="toggleStyle(this)">
                        <input type="checkbox" name="work" value="Suzhou1">
                        <span>緊急避難應變嬰兒床：孩童與毛孩避難時的安心角落</span>
                    </label>
                    <label class="work-item" onclick="toggleStyle(this)">
                        <input type="checkbox" name="work" value="Suzhou2">
                        <span>模組化避難家具：單一元件組裝成百變家具</span>
                    </label>
                </div>
            </div>
            <button class="btn" onclick="goStep2()">下一步：填寫回饋</button>

            <hr class="divider">

            <h2>目前票選情況</h2>
            <div id="stats-container" class="stats-section">
                <div class="center-hint">統計載入中...</div>
            </div>

            <hr class="divider">

            <h2>大家的回饋</h2>
            <div id="wall-container" class="wall-grid">
                <div class="center-hint grid-full">載入中...</div>
            </div>
        </div>

        <div id="page-feedback" class="page">
            <h2>想和設計團隊說什麼呢？</h2>

            <div class="card">
                <label>您的年齡區間</label>
                <select id="input-age">
                    <option value="">請選擇</option>
                    <option value="18歲以下">18歲以下</option>
                    <option value="19-29歲">19-29歲</option>
                    <option value="30-39歲">30-39歲</option>
                    <option value="40-49歲">40-49歲</option>
                    <option value="50-64歲">50-64歲</option>
                    <option value="65歲以上">65歲以上</option>
                </select>

                <label>您家裡有哪些成員？（可多選）</label>
                <div class="chip-group" id="family-group">
                    <div class="chip" onclick="toggleChip(this)" data-val="Single">只有我自己</div>
                    <div class="chip" onclick="toggleChip(this)" data-val="Partner">有伴侶</div>
                    <div class="chip" onclick="toggleChip(this)" data-val="Baby">有嬰孩</div>
                    <div class="chip" onclick="toggleChip(this)" data-val="Pet">有毛孩</div>
                    <div class="chip" onclick="toggleChip(this)" data-val="Elderly">有年長者</div>
                </div>
            </div>

            <div class="card">
                <label>你想對哪一個設計團隊說呢？</label>
                <select id="input-target">
                    <option value="Taipei1">助眠罩：避難時的遮光好眠設計</option>
                    <option value="Taipei2">靜心屏：在緊急避難環境劃出一隅私人空間</option>
                    <option value="Suzhou1">緊急避難應變嬰兒床：孩童與毛孩避難時的安心角落</option>
                    <option value="Suzhou2">模組化避難家具：單一元件組裝成百變家具</option>
                </select>

                <label>我想告訴設計團隊...</label>
                <textarea id="input-content" placeholder="請輸入你的經驗或修正建議..."></textarea>
            </div>

            <button type="button" id="btn-submit" class="btn" onclick="submitData(event, false)">送出，看大家回饋</button>
            <button type="button" id="btn-more" class="btn btn-outline"
                onclick="submitData(event, true)">送出，再寫一張</button>
        </div>

    </div>

    <div id="modal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="m-target" class="modal-title"></h3>
            <p id="m-meta" class="modal-meta"></p>
            <hr class="divider--modal">
            <p id="m-text" class="modal-text"></p>
            <button class="btn btn-outline" onclick="closeModal()">關閉</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 請替換成你部署後的 Web App URL
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzlkkoiLozWBEJYNuraISxy5pZakk7pJhLyLHTgWcB_oJZZqFdBjuwPhz1CNdz9OMoO/exec";

        let voteData = { works: [] };
        let hasVoted = false;

        // 產品名稱對照表
        const targetNameMap = {
            "Taipei1": "助眠罩",
            "Taipei2": "靜心屏",
            "Suzhou1": "避難嬰兒床",
            "Suzhou2": "模組化避難家具"
        };

        // 初始化：載入便利貼牆和統計數據
        window.onload = function () {
            loadWall();
            loadStats();

            // 如果有 page=wall 參數，可以考慮自動滾動到牆的位置 (可選)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('page') === 'wall') {
                const wall = document.getElementById("wall-container");
                if (wall) wall.scrollIntoView({ behavior: 'smooth' });
            }
        };

        // 讀取投票統計
        function loadStats() {
            const container = document.getElementById("stats-container");

            fetch(SCRIPT_URL + "?action=stats")
                .then(res => res.json())
                .then(json => {
                    if (json.result !== "success" || !json.data) {
                        container.innerHTML = "<p class='center-hint'>暫無統計資料</p>";
                        return;
                    }

                    const data = json.data;
                    const items = [
                        { key: "Taipei1", name: targetNameMap["Taipei1"], count: data.Taipei1 || 0 },
                        { key: "Taipei2", name: targetNameMap["Taipei2"], count: data.Taipei2 || 0 },
                        { key: "Suzhou1", name: targetNameMap["Suzhou1"], count: data.Suzhou1 || 0 },
                        { key: "Suzhou2", name: targetNameMap["Suzhou2"], count: data.Suzhou2 || 0 }
                    ];

                    // 找出最大值來計算百分比
                    const maxCount = Math.max(...items.map(i => i.count), 1);

                    // 先用 width: 0 渲染，之後再動畫
                    container.innerHTML = items.map((item, index) => {
                        const percent = (item.count / maxCount) * 100;
                        return `
                            <div class="bar-item">
                                <div class="bar-label">
                                    <span class="name">${item.name}</span>
                                    <span class="count">${item.count} 票</span>
                                </div>
                                <div class="bar-track">
                                    <div class="bar-fill" data-percent="${percent}" style="width: 0%; transition-delay: ${index * 0.1}s;"></div>
                                </div>
                            </div>
                        `;
                    }).join("");

                    // 使用 Intersection Observer 偵測滾動進入畫面
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                // 進入畫面時觸發動畫
                                container.querySelectorAll('.bar-fill').forEach(bar => {
                                    const percent = bar.getAttribute('data-percent');
                                    bar.style.width = percent + '%';
                                });
                                observer.disconnect(); // 只執行一次
                            }
                        });
                    }, { threshold: 0.3 });

                    observer.observe(container);
                })
                .catch(err => {
                    console.error("Stats fetch error:", err);
                    container.innerHTML = "<p class='center-hint'>統計載入失敗</p>";
                });
        }

        // UI 互動：作品勾選
        function toggleStyle(label) {
            setTimeout(() => {
                const chk = label.querySelector("input");
                label.classList.toggle("selected", chk.checked);
            }, 10);
        }

        // UI 互動：家庭標籤 (Chips)
        function toggleChip(el) {
            el.classList.toggle("active");
        }

        // 步驟 1 -> 步驟 2
        function goStep2() {
            const checked = document.querySelectorAll('input[name="work"]:checked');
            if (checked.length === 0) { alert("請至少選擇一項產品"); return; }

            voteData.works = Array.from(checked).map(c => c.value).join(","); // 結果如 "Taipei1,Suzhou2"

            document.getElementById("page-vote").classList.remove("active");
            document.getElementById("page-feedback").classList.add("active");
            window.scrollTo(0, 0);
        }

        // 送出資料
        function submitData(evt, isMore) {
            if (evt) evt.preventDefault(); // 防止可能的頁面刷新或預設行為
            const age = document.getElementById("input-age").value;
            const target = document.getElementById("input-target").value;
            const content = document.getElementById("input-content").value;

            // 收集家庭標籤 (Chips)
            const familyChips = document.querySelectorAll('#family-group .chip.active');
            const family = Array.from(familyChips).map(c => c.dataset.val).join(",");

            if (!age) { alert("請選擇年齡"); return; }
            if (!content) { alert("請跟設計團隊說說話"); return; }

            const btn1 = document.getElementById("btn-submit");
            const btn2 = document.getElementById("btn-more");

            // 傳送時的統一樣式：灰底、白字、無邊框
            const disabledStyle = { background: '#CCC', color: '#fff', border: 'none' };

            // 根據點擊的按鈕顯示傳送狀態
            if (isMore) {
                btn2.innerText = "傳送中...";
            } else {
                btn1.innerText = "傳送中...";
            }

            // 兩個按鈕都套用 disabled 樣式
            btn1.style.background = disabledStyle.background;
            btn1.style.color = disabledStyle.color;
            btn1.style.border = disabledStyle.border;
            btn2.style.background = disabledStyle.background;
            btn2.style.color = disabledStyle.color;
            btn2.style.border = disabledStyle.border;

            btn1.disabled = true; btn2.disabled = true;

            const requests = [];

            // fetch 選項，防止重定向問題
            const fetchOptions = {
                method: "POST",
                redirect: "follow"
            };

            // 1. 如果還沒投過票，發送投票數據 (Votes)
            if (!hasVoted) {
                const fd1 = new FormData();
                fd1.append("action", "vote");
                fd1.append("selectedWorks", voteData.works);
                fd1.append("age", age);
                fd1.append("family", family);
                requests.push(fetch(SCRIPT_URL, { ...fetchOptions, body: fd1 }));
            }

            // 2. 發送回饋數據 (Feedback)
            const fd2 = new FormData();
            fd2.append("action", "feedback");
            fd2.append("target", target);
            fd2.append("content", content);
            fd2.append("age", age);
            fd2.append("family", family);
            requests.push(fetch(SCRIPT_URL, { ...fetchOptions, body: fd2 }));

            // 使用區域變數保存狀態，避免非同步問題
            const stayOnPage = isMore;

            Promise.all(requests).then(() => {
                hasVoted = true;

                // 恢復按鈕樣式的輔助函式
                function restoreButtonStyles() {
                    btn1.disabled = false;
                    btn2.disabled = false;
                    // 清除所有 inline style，讓 CSS class 生效
                    btn1.style.background = "";
                    btn1.style.color = "";
                    btn1.style.border = "";
                    btn2.style.background = "";
                    btn2.style.color = "";
                    btn2.style.border = "";
                    btn1.innerText = "送出，看大家回饋";
                    btn2.innerText = "送出，再寫一張";
                }

                if (stayOnPage) {
                    // 再寫一張：清空內容，保留個人資料
                    document.getElementById("input-content").value = "";
                    document.getElementById("input-content").focus();

                    // 先恢復按鈕
                    restoreButtonStyles();

                    // 按鈕文字提示（2秒後恢復）
                    btn2.innerText = "送出成功，請繼續填寫";
                    setTimeout(() => {
                        btn2.innerText = "送出，再寫一張";
                    }, 2000);
                } else {
                    // 回到首頁並滾動到牆
                    document.getElementById("page-feedback").classList.remove("active");
                    document.getElementById("page-vote").classList.add("active");

                    // Reset VOTE Page
                    voteData.works = [];
                    hasVoted = false;
                    document.querySelectorAll('input[name="work"]').forEach(chk => {
                        chk.checked = false;
                        chk.parentElement.classList.remove("selected");
                    });

                    // Reset FEEDBACK Page（清空回饋表單）
                    document.getElementById("input-age").value = "";
                    document.getElementById("input-content").value = "";
                    document.getElementById("input-target").value = "Taipei1";
                    document.querySelectorAll('#family-group .chip').forEach(chip => {
                        chip.classList.remove("active");
                    });

                    // 恢復按鈕樣式
                    restoreButtonStyles();

                    loadWall();
                    setTimeout(() => {
                        const wallSection = document.querySelector("#page-vote h2");
                        if (wallSection) wallSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 300);
                }
            }).catch(err => {
                console.error(err);
                alert("連線錯誤，請重試");
                btn1.disabled = false; btn2.disabled = false;
                btn1.style.background = ""; btn1.style.color = ""; btn1.style.border = "";
                btn2.style.background = ""; btn2.style.color = ""; btn2.style.border = "";
                btn1.innerText = "送出，看大家回饋";
                btn2.innerText = "送出，再寫一張";
            });
        }

        // 讀取便利貼牆（帶本地快取）
        const WALL_CACHE_KEY = 'wallDataCache';

        function renderWallItems(data, container) {
            container.innerHTML = "";
            if (!data || data.length === 0) {
                container.innerHTML = "<p class='center-hint grid-full'>暫無留言</p>";
                return;
            }
            // 複製並反轉，避免修改原始資料
            [...data].reverse().forEach((item, index) => {
                const targetName = targetNameMap[item.target] || item.target;
                const div = document.createElement("div");
                div.className = "sticky";
                // 設定動畫延遲，每張便利貼差 0.05 秒
                div.style.transitionDelay = (index * 0.05) + "s";
                div.innerHTML = `
                    <strong class="sticky-title">我想對 ${targetName} 的設計團隊說</strong>
                    <div class="sticky-preview">${item.content}</div>
                `;
                div.onclick = () => showModal({ ...item, targetName });
                container.appendChild(div);
            });

            // 使用 Intersection Observer 偵測每張便利貼進入畫面
            const stickyObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });

            container.querySelectorAll('.sticky').forEach(sticky => {
                stickyObserver.observe(sticky);
            });
        }

        function loadWall() {
            const container = document.getElementById("wall-container");

            // 1. 先嘗試從快取讀取並顯示
            try {
                const cached = localStorage.getItem(WALL_CACHE_KEY);
                if (cached) {
                    const cachedData = JSON.parse(cached);
                    renderWallItems(cachedData, container);
                }
            } catch (e) {
                console.warn("Cache read error:", e);
            }

            // 如果沒有快取，顯示載入中
            if (container.children.length === 0) {
                container.innerHTML = "<div class='center-hint grid-full'>便利貼讀取中...</div>";
            }

            // 2. 在背景抓取最新資料
            fetch(SCRIPT_URL + "?action=read")
                .then(res => {
                    if (!res.ok) throw new Error("Network response was not ok");
                    return res.json();
                })
                .then(json => {
                    // 3. 更新畫面
                    renderWallItems(json.data, container);

                    // 4. 儲存到快取
                    try {
                        localStorage.setItem(WALL_CACHE_KEY, JSON.stringify(json.data));
                    } catch (e) {
                        console.warn("Cache write error:", e);
                    }
                })
                .catch(err => {
                    console.error("Fetch error:", err);
                    // 如果有快取資料就不顯示錯誤（已經顯示了快取）
                    if (container.children.length === 0 || container.querySelector('.sticky') === null) {
                        container.innerHTML = `<div class='center-hint grid-full' style='color:red;'>
                            讀取失敗<br>
                            <small style="color:#666">${err.message}</small><br>
                            <button type="button" class="btn btn-outline" onclick="loadWall()" style="margin-top:10px; width:auto; display:inline-block; padding: 8px 16px;">重試</button>
                        </div>`;
                    }
                });
        }

        function showModal(item) {
            const targetName = item.targetName || targetNameMap[item.target] || item.target;
            document.getElementById("m-target").innerText = "我想對 " + targetName + " 的設計團隊說";
            // document.getElementById("m-meta").innerText = `${item.age} / ${item.family}`; // 隱藏個資
            document.getElementById("m-text").innerText = item.content;
            document.getElementById("modal").classList.add("show");
        }
        function closeModal() { document.getElementById("modal").classList.remove("show"); }
    </script>

</body>

</html>